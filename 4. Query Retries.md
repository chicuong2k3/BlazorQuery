

# Query Retries in BlazorQuery

When a query fails (the query function throws an exception), **BlazorQuery** will automatically retry 
the query if the number of consecutive retries has not exceeded the limit specified 
in the query options.

You can configure retries both on a global level (via `QueryClient` defaults) and 
on an individual query level (`QueryOptions<T>`).

### Retry Options

- Setting `Retry = 0` will disable retries.
- Setting `Retry = 3` will allow up to 3 total attempts (initial attempt + 2 retries).
- Custom retry logic can be provided via `RetryFunc: Func<int, Exception, bool>`, 
allowing conditional retries depending on the attempt number or exception.
- Retries apply only when an exception is thrown from the query function.
- Infinite retries are supported via `RetryInfinite = true`.

**Important:** Unlike React Query where `retry: 3` means 3 retries after the initial attempt 
(4 total attempts), BlazorQuery's `retry: 3` means a maximum of 3 total attempts. 
This is a design choice for simplicity.

```csharp
var query = new UseQuery<string>(
    new QueryOptions<string>(
        queryKey: new("todos", 1),
        queryFn: async ctx => await FetchTodoListPageAsync(),
        staleTime: TimeSpan.FromMinutes(5),
        networkMode: NetworkMode.Online,
        refetchOnReconnect: true,
        retry: 5 // Allow up to 5 total attempts (initial + 4 retries)
    ),
    queryClient
);
```

# Retry Delay

Retries in BlazorQuery are not immediate. A backoff delay is applied between retry 
attempts to reduce load and collisions.

By default, retries in **BlazorQuery** uses exponential backoff with jitter for retries:
- Initial delay is 1000ms.
- Delay doubles with each attempt (2^attempt * 1000ms).
- A random jitter of up to 300ms is added to prevent collisions.
- Maximum delay is capped by `MaxRetryDelay` (default: 30 seconds).
- Optionally, a custom retry delay function can be provided via 
`RetryDelayFunc: Func<int, TimeSpan>`.

```csharp
int delayMs;
if (_queryOptions.RetryDelayFunc != null)
{
    delayMs = (int)_queryOptions.RetryDelayFunc(attempt).TotalMilliseconds;
}
else
{
    double expDelay = Math.Pow(2, attempt) * 1000;
    double jitter = Random.Shared.NextDouble() * 300; // Thread-safe random
    delayMs = (int)Math.Min(expDelay + jitter, maxRetryDelay.TotalMilliseconds);
}

await Task.Delay(delayMs, cancellationToken);
```

# Custom Retry Delay

- Provide a custom delay function via `RetryDelayFunc: Func<int, TimeSpan>`.
- The function receives the current attempt index (0-based) and returns a `TimeSpan` 
to wait before the next retry.