
# What is a Query Function?

A **Query Function** is any asynchronous method that fetches data. 
It must either return **a result** or **throw an exception** so that BlazorQuery can track **loading** 
and **error** states.

Query functions receive a `QueryFunctionContext` that provides:
- `QueryKey`: uniquely identifies the query.
- `Signal`: a `CancellationToken` that allows query cancellation.
- `Meta`: optional metadata for the query.

# Basic Usage

You can define a query function in several ways depending on your needs:

```csharp
// Simple query without parameters
var query = new UseQuery<List<string>>(new QueryOptions<List<string>>(
    queryKey: new QueryKey("todos"),
    queryFn: async ctx => await FakeApi.GetTodosAsync()
), _client);

// Query with a single parameter
var query = new UseQuery<string>(new QueryOptions<string>(
    queryKey: new QueryKey("todos"),
    queryFn: async ctx => await FakeApi.GetTodoByIdAsync(1)
), _client);

// Using QueryFunctionContext to access query key values
var query = new UseQuery<string>(new QueryOptions<string>(
    queryKey: new QueryKey("todos", -1),
    queryFn: async ctx => await FakeApi.GetTodoByIdAsync((int)ctx.QueryKey[1]!)
), _client);
```

# Handling Errors

BlazorQuery tracks query errors automatically. A query is considered failed if the function:
- Throws an exception, or
- Returns a faulted `Task<T>`

```csharp
int todoId = -1;
var query = new UseQuery<string>(new QueryOptions<string>(
    queryKey: new QueryKey("todo", todoId),
    queryFn: async ctx => {
        if (somethingGoesWrong)
            throw new Exception("Something went wrong");

        if (somethingElseGoesWrong)
            return await Task.FromException<string>(new Exception("Something else went wrong"));

         return await FetchTodoByIdAsync(todoId);
    }
), client: _client);

await query.ExecuteAsync();

if (query.IsError)
    Console.WriteLine(query.Error!.Message);
```

# Usage with HttpClient

Some HTTP clients (like `HttpClient`) do not automatically throw exceptions for non-success HTTP responses. 
In that case, you should check the response and throw manually:

```csharp
int todoId = -1;
var query = new UseQuery<string>(new QueryOptions<string>(
    queryKey: new QueryKey("todo", todoId),
    queryFn: async ctx => {
        var response = await http.GetAsync($"/api/todos/{todoId}");
        if (!response.IsSuccessStatusCode)
            throw new Exception($"Network response was not ok: {response.StatusCode}");

        return await response.Content.ReadFromJsonAsync<string>()!;
    }
), client: _client);

await query.ExecuteAsync();
```

# Cancellation

You can pass a `CancellationToken` to `ExecuteAsync` to cancel a running query:

```csharp
var cts = new CancellationTokenSource();
await query.ExecuteAsync(cts.Token);

// Later, cancel if needed
cts.Cancel();
```

The token is automatically passed to your query function via `QueryFunctionContext.Signal`.