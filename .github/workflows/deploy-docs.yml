name: Deploy SwrSharp Docs to GitHub Pages
on:
  push:
    branches: [ main, master ]
    paths:
      - 'docs/SwrSharp.Doc/**'
      - '.github/workflows/deploy-docs.yml'
  workflow_dispatch:
permissions:
  contents: read
  pages: write
  id-token: write
concurrency:
  group: "pages"
  cancel-in-progress: false
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - name: Restore dependencies
        run: dotnet restore
        working-directory: ./docs/SwrSharp.Doc
      - name: Build
        run: dotnet build --configuration Release --no-restore
        working-directory: ./docs/SwrSharp.Doc
      - name: Publish
        run: |
          dotnet publish --configuration Release --no-build --output publish
          echo "=== Copying Content to publish directory ==="
          cp -r Content publish/
          echo "=== Content copied ==="
          ls -la publish/Content/
        working-directory: ./docs/SwrSharp.Doc
      - name: Generate static site
        run: |
          cd publish
          echo "=== Starting BlazorStatic generator ==="
          echo "Working directory: $(pwd)"
          ASPNETCORE_ENVIRONMENT=Production timeout 180s dotnet SwrSharp.Doc.dll || true
          echo "=== Generator completed ==="
        working-directory: ./docs/SwrSharp.Doc
      - name: Find and prepare output
        run: |
          echo "=== Searching for output directory ==="
          # Check multiple possible locations
          if [ -d "./docs/SwrSharp.Doc/output" ]; then
            echo "✓ Found output at: ./docs/SwrSharp.Doc/output"
            OUTPUT_PATH="./docs/SwrSharp.Doc/output"
          elif [ -d "./docs/SwrSharp.Doc/publish/output" ]; then
            echo "✓ Found output at: ./docs/SwrSharp.Doc/publish/output"
            OUTPUT_PATH="./docs/SwrSharp.Doc/publish/output"
          elif [ -d "./docs/SwrSharp.Doc/bin/Release/net10.0/output" ]; then
            echo "✓ Found output at: ./docs/SwrSharp.Doc/bin/Release/net10.0/output"
            OUTPUT_PATH="./docs/SwrSharp.Doc/bin/Release/net10.0/output"
          else
            echo "❌ Output directory not found in common locations"
            echo "Searching entire docs directory..."
            find ./docs/SwrSharp.Doc -name "output" -type d
            echo ""
            echo "Creating fallback output directory..."
            mkdir -p ./docs/SwrSharp.Doc/output
            echo "<html><body><h1>Error: Static site generation failed</h1></body></html>" > ./docs/SwrSharp.Doc/output/index.html
            OUTPUT_PATH="./docs/SwrSharp.Doc/output"
          fi
          # Add .nojekyll to prevent GitHub Pages from ignoring _framework
          touch ${OUTPUT_PATH}/.nojekyll
          # Copy index.html as 404.html for SPA routing fallback
          if [ -f "${OUTPUT_PATH}/index.html" ]; then
            cp ${OUTPUT_PATH}/index.html ${OUTPUT_PATH}/404.html
          fi
          echo "OUTPUT_PATH=${OUTPUT_PATH}" >> $GITHUB_ENV
          echo ""
          echo "=== Output contents ==="
          ls -la ${OUTPUT_PATH} | head -30
          echo ""
          FILE_COUNT=$(find ${OUTPUT_PATH} -type f | wc -l)
          echo "Total files: ${FILE_COUNT}"
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.OUTPUT_PATH }}
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
