@page "/samples/mutations"
@inherits SwrSharpComponentBase

<PageTitle>Mutations</PageTitle>

<h1>Mutations</h1>
<p>Demonstrates mutation lifecycle: <code>OnMutate</code>, <code>OnSuccess</code>, <code>OnError</code>, <code>OnSettled</code>, and <code>Reset</code>.</p>

<h4>Create Item</h4>
<div class="mb-3">
    <div class="input-group">
        <input class="form-control" @bind="_itemName" placeholder="Item name..."/>
        <button class="btn btn-primary" @onclick="HandleCreate" disabled="@_create.IsPending">
            @(_create.IsPending ? "Creating..." : "Create")
        </button>
    </div>
</div>

<h4>Mutation State</h4>
<table class="table table-sm">
    <tr><td>Status</td><td><span class="badge bg-@StatusColor">@_create.Status</span></td></tr>
    <tr><td>Data</td><td>@(_create.Data ?? "—")</td></tr>
    <tr><td>Error</td><td>@(_create.Error?.Message ?? "—")</td></tr>
    <tr><td>Variables</td><td>@(_create.Variables ?? "—")</td></tr>
    <tr><td>SubmittedAt</td><td>@(_create.SubmittedAt?.ToString("T") ?? "—")</td></tr>
</table>

<div class="d-flex gap-2">
    <button class="btn btn-outline-secondary" @onclick="() => _create.Reset()">Reset</button>
    <button class="btn btn-outline-danger" @onclick="HandleCreateFail">Create (will fail)</button>
</div>

<h4 class="mt-3">Callback Log</h4>
<ul class="list-group">
    @foreach (var log in _logs)
    {
        <li class="list-group-item py-1 small">@log</li>
    }
</ul>

@code {
    private UseMutation<string, string> _create = null!;
    private string _itemName = "";
    private readonly List<string> _logs = new();

    private string StatusColor => _create.Status switch
    {
        MutationStatus.Idle => "secondary",
        MutationStatus.Pending => "warning",
        MutationStatus.Success => "success",
        MutationStatus.Error => "danger",
        _ => "secondary"
    };

    protected override void OnParametersSet()
    {
        _create = UseMutation(new MutationOptions<string, string>
        {
            MutationFn = async name =>
            {
                await Task.Delay(500);
                if (name.StartsWith("fail", StringComparison.OrdinalIgnoreCase))
                    throw new Exception($"Failed to create '{name}'");
                return $"Created: {name} (id: {Random.Shared.Next(1000)})";
            },
            OnMutate = (vars, _) => { _logs.Add($"OnMutate: {vars}"); return Task.FromResult<object?>(null); },
            OnSuccess = (data, vars, _, _) => { _logs.Add($"OnSuccess: {data}"); return Task.CompletedTask; },
            OnError = (ex, vars, _, _) => { _logs.Add($"OnError: {ex.Message}"); return Task.CompletedTask; },
            OnSettled = (data, ex, vars, _, _) => { _logs.Add($"OnSettled: data={data}, error={ex?.Message}"); return Task.CompletedTask; }
        });
    }

    private async Task HandleCreate()
    {
        if (string.IsNullOrWhiteSpace(_itemName)) return;
        try { await _create.MutateAsync(_itemName); } catch { /* handled by callbacks */ }
        _itemName = "";
    }

    private async Task HandleCreateFail()
    {
        try { await _create.MutateAsync("fail-item"); } catch { /* handled by callbacks */ }
    }
}
