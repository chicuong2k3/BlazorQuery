<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <base href="@BaseHref"/>
    <title>SwrSharp - .NET Data Fetching & Caching</title>

    <!-- Theme init (before render to prevent FOUC) -->
    <script>
        (function() {
            var theme = localStorage.getItem('theme');
            if (theme === 'light') {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>

    <link rel="stylesheet" href="css/tailwind.css" />

    <!-- Prism.js themes (dual) -->
    <link id="prism-dark" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <link id="prism-light" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" rel="stylesheet" disabled />
    <script>
        (function() {
            if (localStorage.getItem('theme') === 'light') {
                document.getElementById('prism-dark').disabled = true;
                document.getElementById('prism-light').disabled = false;
            }
        })();
    </script>

    <HeadOutlet/>
</head>

<body class="bg-white dark:bg-[#0d1117] font-sans text-gray-800 dark:text-gray-300 antialiased">
<Routes/>

<!-- Prism.js core + language components -->
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-csharp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-typescript.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-bash.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-powershell.min.js"></script>

<script>
    // Theme toggle
    window.toggleTheme = function() {
        var html = document.documentElement;
        var isDark = html.classList.contains('dark');
        if (isDark) {
            html.classList.remove('dark');
            localStorage.setItem('theme', 'light');
            document.getElementById('prism-dark').disabled = true;
            document.getElementById('prism-light').disabled = false;
        } else {
            html.classList.add('dark');
            localStorage.setItem('theme', 'dark');
            document.getElementById('prism-dark').disabled = false;
            document.getElementById('prism-light').disabled = true;
        }
        if (window.Prism) Prism.highlightAll();
    };

    // Language alias map
    const langMap = {
        'cs': 'csharp', 'c#': 'csharp',
        'js': 'javascript',
        'ts': 'typescript', 'tsx': 'typescript',
        'sh': 'bash', 'shell': 'bash', 'zsh': 'bash',
        'yml': 'yaml',
        'py': 'python',
        'rb': 'ruby',
        'md': 'markdown',
        'html': 'markup', 'xml': 'markup', 'svg': 'markup',
        'razor': 'cshtml'
    };

    // Initialize code blocks: highlight + copy button + language label
    window.initCodeBlocks = function () {
        document.querySelectorAll('.prose pre code').forEach(function (codeEl) {
            var pre = codeEl.parentElement;
            if (pre.parentElement && pre.parentElement.classList.contains('code-block-wrapper')) return;

            var lang = '';
            var classes = codeEl.className || '';
            var match = classes.match(/language-(\S+)/);
            if (match) lang = match[1];

            var prismLang = langMap[lang] || lang;
            if (prismLang && !codeEl.classList.contains('language-' + prismLang)) {
                codeEl.className = 'language-' + prismLang;
                pre.className = 'language-' + prismLang;
            }

            var wrapper = document.createElement('div');
            wrapper.className = 'code-block-wrapper';
            pre.parentNode.insertBefore(wrapper, pre);
            wrapper.appendChild(pre);

            if (lang) {
                var label = document.createElement('span');
                label.className = 'code-lang-label';
                label.textContent = lang;
                wrapper.appendChild(label);
            }

            var btn = document.createElement('button');
            btn.className = 'copy-code-btn';
            btn.innerHTML = '&#x2398; Copy';
            btn.addEventListener('click', function () {
                var text = codeEl.textContent;
                navigator.clipboard.writeText(text).then(function () {
                    btn.textContent = '\u2713 Copied!';
                    btn.classList.add('copied');
                    setTimeout(function () {
                        btn.innerHTML = '&#x2398; Copy';
                        btn.classList.remove('copied');
                    }, 2000);
                });
            });
            wrapper.appendChild(btn);
        });

        if (window.Prism) Prism.highlightAll();
    };

    // Copy full page text
    window.copyPageContent = function () {
        var article = document.querySelector('article');
        if (!article) return false;
        navigator.clipboard.writeText(article.innerText);
        return true;
    };

    // Copy Page button init
    function initCopyPageButton() {
        var btn = document.getElementById('copy-page-btn');
        if (!btn || btn.dataset.initialized) return;
        btn.dataset.initialized = 'true';
        btn.addEventListener('click', function() {
            if (window.copyPageContent()) {
                var original = btn.textContent;
                btn.textContent = '\u2713 Copied!';
                btn.classList.add('text-green-400');
                setTimeout(function() {
                    btn.textContent = original;
                    btn.classList.remove('text-green-400');
                }, 2000);
            }
        });
    }

    // Search modal
    var searchModal = null;
    var searchInput = null;
    var searchResults = null;
    var searchData = [];
    var selectedIndex = 0;

    function createSearchModal() {
        if (document.getElementById('search-modal')) return;

        var modal = document.createElement('div');
        modal.id = 'search-modal';
        modal.className = 'fixed inset-0 z-50 hidden';
        modal.innerHTML = `
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeSearchModal()"></div>
            <div class="absolute top-[10%] left-1/2 -translate-x-1/2 w-full max-w-2xl px-4">
                <div class="bg-white dark:bg-[#0d1117] border border-gray-200 dark:border-[#21262d] rounded-xl shadow-2xl overflow-hidden">
                    <div class="flex items-center px-4 border-b border-gray-200 dark:border-[#21262d]">
                        <svg class="w-5 h-5 text-gray-400 dark:text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <input id="search-modal-input" type="text" placeholder="Search documentation..."
                               class="flex-1 px-3 py-4 bg-transparent text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none text-base">
                        <kbd class="px-2 py-1 text-xs text-gray-500 bg-gray-100 dark:bg-[#161b22] rounded border border-gray-200 dark:border-[#21262d]">ESC</kbd>
                    </div>
                    <div id="search-results" class="max-h-[60vh] overflow-y-auto">
                        <div class="px-4 py-8 text-center text-gray-500 text-sm">
                            Type to search documentation...
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        searchModal = modal;
        searchInput = document.getElementById('search-modal-input');
        searchResults = document.getElementById('search-results');

        searchInput.addEventListener('input', debounce(performSearch, 150));
        searchInput.addEventListener('keydown', handleSearchKeydown);
    }

    function loadSearchData() {
        searchData = [];
        document.querySelectorAll('nav a[href*="/docs/"]').forEach(function(link) {
            var section = link.closest('div');
            var category = section ? (section.querySelector('h3') || {}).textContent || 'Docs' : 'Docs';
            searchData.push({
                title: link.textContent.trim(),
                url: link.getAttribute('href'),
                category: category.trim()
            });
        });
    }

    window.openSearchModal = function() {
        createSearchModal();
        loadSearchData();
        searchModal.classList.remove('hidden');
        searchInput.value = '';
        searchInput.focus();
        selectedIndex = 0;
        document.body.style.overflow = 'hidden';
    };

    window.closeSearchModal = function() {
        if (searchModal) {
            searchModal.classList.add('hidden');
            document.body.style.overflow = '';
        }
    };

    function performSearch() {
        var query = searchInput.value.toLowerCase().trim();
        selectedIndex = 0;

        if (!query) {
            searchResults.innerHTML = '<div class="px-4 py-8 text-center text-gray-500 text-sm">Type to search documentation...</div>';
            return;
        }

        var results = searchData.filter(function(item) {
            return item.title.toLowerCase().includes(query) || item.category.toLowerCase().includes(query);
        });

        if (results.length === 0) {
            searchResults.innerHTML = '<div class="px-4 py-8 text-center text-gray-500 text-sm">No results found for "' + query + '"</div>';
            return;
        }

        searchResults.innerHTML = results.map(function(item, i) {
            var highlighted = item.title.replace(new RegExp('(' + escapeRegex(query) + ')', 'gi'), '<span class="text-red-400 font-semibold">$1</span>');
            return '<a href="' + item.url + '" class="search-result flex items-center px-4 py-3 hover:bg-gray-100 dark:hover:bg-[#161b22] transition ' + (i === 0 ? 'bg-gray-100 dark:bg-[#161b22]' : '') + '" data-index="' + i + '">' +
                '<div class="flex-1"><div class="text-gray-900 dark:text-white text-sm">' + highlighted + '</div><div class="text-gray-500 text-xs mt-0.5">' + item.category + '</div></div>' +
                '<svg class="w-4 h-4 text-gray-400 dark:text-gray-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></a>';
        }).join('');
    }

    function handleSearchKeydown(e) {
        var results = searchResults.querySelectorAll('.search-result');
        if (results.length === 0) return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, results.length - 1);
            updateSelection(results);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, 0);
            updateSelection(results);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (results[selectedIndex]) {
                window.location.href = results[selectedIndex].getAttribute('href');
            }
        }
    }

    function updateSelection(results) {
        results.forEach(function(el, i) {
            if (i === selectedIndex) {
                el.classList.add('bg-gray-100', 'dark:bg-[#161b22]');
                el.scrollIntoView({ block: 'nearest' });
            } else {
                el.classList.remove('bg-gray-100', 'dark:bg-[#161b22]');
            }
        });
    }

    function escapeRegex(str) {
        return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function debounce(fn, ms) {
        var timeout;
        return function() {
            var args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(function() { fn.apply(null, args); }, ms);
        };
    }

    // Search triggers
    function initSearchTriggers() {
        document.querySelectorAll('input[placeholder*="Search"]').forEach(function(input) {
            if (input.dataset.searchInit) return;
            input.dataset.searchInit = 'true';
            input.addEventListener('click', function(e) {
                e.preventDefault();
                openSearchModal();
            });
            input.addEventListener('focus', function(e) {
                e.preventDefault();
                this.blur();
                openSearchModal();
            });
        });
    }

    // Keyboard shortcut Cmd/Ctrl + K
    document.addEventListener('keydown', function(e) {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            openSearchModal();
        }
        if (e.key === 'Escape') {
            closeSearchModal();
        }
    });

    // Init all
    function initAll() {
        initCopyPageButton();
        initSearchTriggers();
        window.initCodeBlocks();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAll);
    } else {
        initAll();
    }

    var _initProcessing = false;
    var _initTimer = null;

    document.addEventListener('DOMContentLoaded', function() {
        var observer = new MutationObserver(function(mutations) {
            if (_initProcessing) return;
            var dominated = mutations.some(function(m) {
                for (var i = 0; i < m.addedNodes.length; i++) {
                    var node = m.addedNodes[i];
                    if (node.nodeType === 1 && !node.classList.contains('code-block-wrapper') &&
                        !node.classList.contains('copy-code-btn') && !node.classList.contains('code-lang-label') &&
                        node.id !== 'search-modal') {
                        return true;
                    }
                }
                return false;
            });
            if (!dominated) return;
            clearTimeout(_initTimer);
            _initTimer = setTimeout(function() {
                _initProcessing = true;
                initAll();
                _initProcessing = false;
            }, 300);
        });
        var main = document.querySelector('body');
        if (main) {
            observer.observe(main, { childList: true, subtree: true });
        }
    });
</script>
</body>

</html>

@code {
    [Inject] private IWebHostEnvironment Env { get; set; } = default!;
    private string BaseHref => Env.IsDevelopment() ? "/" : "/BlazorQuery/";
}
